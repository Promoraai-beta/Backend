version: '3.8'

services:
  # Backend API Service
  backend:
    build:
      context: ./Backend
      dockerfile: Dockerfile
    container_name: promora-backend
    ports:
      - "5001:5001"
    volumes:
      # Mount Docker socket to allow backend to exec into MCP containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Note: MCP servers are in separate containers, accessed via Docker exec
      # No need to mount MCP-Servers directory
      # Note: uploads directory created inside container, no mount needed for testing
      # - ./uploads:/app/uploads
    environment:
      - NODE_ENV=production
      - PORT=5001
      - MCP_USE_DOCKER=true
      # Database (Supabase)
      - DATABASE_URL=${DATABASE_URL}
      # Authentication
      - JWT_SECRET=${JWT_SECRET}
      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - SUPABASE_STORAGE_BUCKET=${SUPABASE_STORAGE_BUCKET:-video}
      # Email Configuration
      - EMAIL_ENABLED=${EMAIL_ENABLED:-true}
      - FROM_EMAIL=${FROM_EMAIL}
      - FROM_NAME=${FROM_NAME:-Promora Assessment Platform}
      - FRONTEND_URL=${FRONTEND_URL}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      # Optional: SMTP (if not using SendGrid)
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURE=${SMTP_SECURE}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      # Supabase SMTP (alternative to regular SMTP)
      - SUPABASE_SMTP_HOST=${SUPABASE_SMTP_HOST}
      - SUPABASE_SMTP_PORT=${SUPABASE_SMTP_PORT}
      - SUPABASE_SMTP_SECURE=${SUPABASE_SMTP_SECURE}
      - SUPABASE_SMTP_USER=${SUPABASE_SMTP_USER}
      - SUPABASE_SMTP_PASS=${SUPABASE_SMTP_PASS}
      # Judge0 (optional)
      - JUDGE0_API_KEY=${JUDGE0_API_KEY}
      # CORS
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000}
      # MCP Servers Path (for stdio communication - will need adjustment)
      - MCP_SERVERS_PATH=/app/mcp-servers
    restart: unless-stopped
    networks:
      - promora-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend Next.js Service
  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:5001}
        - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL:-ws://localhost:5001}
        - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
        - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
    container_name: promora-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      # Runtime environment variables (for Next.js)
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:5001}
      - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL:-ws://localhost:5001}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - promora-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # MCP Server A: Job Analysis
  mcp-server-a:
    build:
      context: ./MCP-Servers
      dockerfile: Dockerfile.server-a
    container_name: promora-mcp-server-a
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    networks:
      - promora-network
    # Note: MCP servers use stdio, so they need to be accessed via docker exec
    # or we need to modify the backend to use HTTP endpoints
    # For now, keeping them separate but backend will need to be updated

  # MCP Server B: Template Builder
  mcp-server-b:
    build:
      context: ./MCP-Servers
      dockerfile: Dockerfile.server-b
    container_name: promora-mcp-server-b
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    networks:
      - promora-network

  # MCP Server C: Monitoring
  mcp-server-c:
    build:
      context: ./MCP-Servers
      dockerfile: Dockerfile.server-c
    container_name: promora-mcp-server-c
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    networks:
      - promora-network

networks:
  promora-network:
    driver: bridge

volumes:
  uploads:
    driver: local
